<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>Josquin Music Project</title>
  <!--
    This program loads note data for a single work in CSV format
    and renders it using D3.js.

    By Curran Kelleher <curran.kelleher@gmail.com>
      & Seemant Kulleen <seemantk@gmail.com>
    April 2016
  -->

  <!-- Bootstrap
    For reset and grid layout.
    from http://getbootstrap.com/customize/?id=c9c26f4080624c8af8ea9d80a6a64013
  -->
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <style>
      rect, li {
          transition: opacity 0.5s ease;
      }
      rect.note {
          fill-opacity: 0.5;
      }
      .subdued {
          opacity: 0.1;
      }
      #legend li {
          cursor: pointer;
      }
      #legend li text {
          margin-left: 1em;
      }
      header {
          background-image: url('img/josquin.jpg');
          background-size: contain;
          background-repeat: no-repeat;
      }

      .brush .extent {
          stroke: black;
          fill-opacity: .08;
          stroke-opacity: .2;
          shape-rendering: crispEdges;
      }

      /* Tooltip styling inspired by http://bl.ocks.org/Caged/6476579 */
      .d3-tip {
          line-height: 1;
          padding: 5px;
          background: rgba(0, 0, 0, 0.5);
          color: #fff;
          border-radius: 2px;
      }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.7/d3-tip.min.js"></script>
  <script src="js/legend.js"></script>
  <script src="js/notescanvas.js"></script>
  <script src="js/notesbook.js"></script>
  <script src="js/brushview.js"></script>
  <script src="js/combineSeparateUI.js"></script>
</head>

<body>
  <header class="page-header text-center">
    <h1>Josquin Music Project</h1>
    <h2>Work in Progress</h2>
  </header>
  <article>
    <div class="container">
      <div class="row">
        <div id="notes" class="col-xs-12 col-lg-10"></div>
        <div class="col-xs-12 col-lg-2">
          <div id="combine-separate-ui"></div>
          <div id="legend"></div>
        </div>
      </div><!--.row-->
      <div class="row">
        <span>Note names: </span> <p id="note-names-string"></p>
        <span>Note durations: </span><p id="note-durations-string"></p>
      </div><!--.row-->
    </div><!--.container-->
  </article>
  <script>
    var width = 960
      , height = 150 // height of one strip of notes
      , notesViewContext = NotesCanvas()
      , notesViewContextSVG = d3.select("#notes")
          .append("svg")
            .attr("width", width)
            .attr("height", height)
      , notesViewFocus = NotesBook()
      , notesViewFocusSVG = d3.select("#notes")
          .append("svg")
            .attr("width", width)
            .attr("height", 3 * height)
      , combineSeparateUI = CombineSeparateUI()
      , brush = BrushView()
      , colorLegend = ColorLegend()
      , colorScale = d3.scale.category10()
      , tip = d3.tip().attr("class", "d3-tip")
    ;
    var defaultWork = "Jos2721-La_Bernardina"
      , hash = window.location.hash
      , work = hash ? hash.substr(1) : defaultWork
      , jsonURL = "http://josquin.stanford.edu/cgi-bin/jrp?a=proll-json&f=" + work
    ;
    colorLegend.colorScale(colorScale);

    d3.json(jsonURL, function(error, proll) {
        if(error) throw error;
        chartify(parseJSON(proll));
    });

    function parseJSON(proll) {
        var notes = []
          , voice
        ;
        proll.partdata.forEach(function(part) {
            voice = proll.partnames[part.partindex];
            part.notedata.forEach(function(note) {
                notes.push({
                      pitch: note.pitch.b7
                    , pitchName: note.pitch.name
                    , time: note.starttime[0]
                    , duration: note.duration[0]
                    , voice: voice
                });
            });
        });
        // Group the notes by voice
        proll.notes = d3.nest()
            .key(function(d) { return d.voice; })
            .map(notes, d3.map)
        ;
        return proll;
    } // parseJSON()

    function chartify(data) {
        var signal = d3.dispatch("hilite", "zoom", "separate");

        colorScale
            .domain(data.partnames)
        ;
        notesViewContext
            .colorScale(colorScale)
            .width(width)
            .height(height)
            .connect(signal)
        ;
        notesViewFocus
            .colorScale(colorScale)
            .width(width)
            .height(height * 3)
            .tooltip(tip)
            .connect(signal)
        ;
        colorLegend
            .connect(signal)
        ;
        d3.select("#combine-separate-ui")
            .call(combineSeparateUI.connect(signal))
        ;
        renderColorLegend();
        renderNotesViewContext(data.notes);
        renderNotesViewFocus(data);

        var full = [[0, data.scorelength], [data.minpitch.b7, data.maxpitch.b7]];
        notesViewContext.zoom(full);
        notesViewFocus.zoom(full);

        brush
            .height(height)
            .connect(signal)
        ;
        // When the user brushes in the context view,
        signal.on("zoom", function (zoom){
            // Update the focus view.
            notesViewFocus.zoom(zoom.extent, zoom.ended);

          })
        ;
        // When the user clicks on a legend item, they are either:
        //  1. selecting a voice to highlight
        //  2. deselecting it to show all voices.
        signal.on("hilite", notesViewFocus.hilite);
        // When the user selects to separate or combine...
        signal.on("separate", function (separate){
           notesViewFocus.separate(separate);
           renderNotesViewFocus(data.notes);
         })
        ;
    } // chartify()

    function renderNotesViewContext(data){
        notesViewContextSVG
          .append("g")
            .datum({ key: "full", values: d3.merge((data.value())) })
            .call(notesViewContext)
            .call(brush.x(notesViewContext.x()))
        ;
    } // renderNotesViewContext()
    function renderNotesViewFocus(data){
        notesViewFocusSVG
            .datum(data)
            .call(notesViewFocus)
        ;
    } // renderNotesViewContext()
    function renderColorLegend(){
        colorLegend
            .noteHeight(notesViewContext.noteHeight())
            .roundedCornerSize(notesViewContext.roundedCornerSize())
        ;
        colorLegend();
    } // renderColorLegend()
  </script>
</body>
