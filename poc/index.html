<!DOCTYPE html>
<head>
  <meta charset="utf-8">

  <!--
    This program loads note data for a single work in CSV format
    and renders it using D3.js.

    By Curran Kelleher <curran.kelleher@gmail.com>
      & Seemant Kulleen <seemantk@gmail.com>
    April 2016
  -->

  <!-- Bootstrap
    For reset and grid layout.
    from http://getbootstrap.com/customize/?id=c9c26f4080624c8af8ea9d80a6a64013
  -->
  <link rel="stylesheet" href="bootstrap.min.css">
  <style>
      rect, li {
          transition: opacity 0.5s ease;
      }
      rect.note {
          fill-opacity: 0.5;
      }
      .subdued {
          opacity: 0.1;
      }
      #legend li {
          cursor: pointer;
      }
      #legend li text {
          margin-left: 1em;
      }
      header {
          background-image: url('josquin.jpg');
          background-size: contain;
          background-repeat: no-repeat;
      }

      .brush .extent {
          stroke: black;
          fill-opacity: .08;
          stroke-opacity: .2;
          shape-rendering: crispEdges;
      }
  </style>
  <script src="d3.min.js"></script>
</head>

<body>
  <header class="page-header text-center">
    <h1>Josquin Music Project</h1>
    <h2>Proof of Concept</h2>
  </header>
  <article>
    <div class="container">
      <div class="row">
        <div id="notes" class="col-xs-12 col-lg-10">
          <svg id="notes-svg"></svg>
        </div>
        <div id="legend" class="col-xs-12 col-lg-2"></div>
      </div><!--.row-->
    </div><!--.container-->
  </article>
  <script>

    main();
    function main(){
        var notesView = NotesView()
          , colorLegend = ColorLegend()
          , csvPath = "Jos2721-La_Bernardina.csv"
          , colorScale = d3.scale.category10()
        ;

        notesView
            .colorScale(colorScale)
            .width(900)
            .height(150)
        ;

        colorLegend.colorScale(colorScale);

        d3.csv(csvPath, type, function (data){

            d3.select("#notes-svg")
                .datum(data)
                .call(notesView);

            colorLegend
                .noteHeight(notesView.noteHeight())
                .roundedCornerSize(notesView.roundedCornerSize())
            ;

            colorLegend();
        });

        // Parse strings from CSV data into numbers.
        function type(d){
            d.pitch = +d.pitch;
            d.time = +d.time;
            d.duration = +d.duration;
            return d;
        }
    }

    function NotesView(){
        var width = 500
          , height = 500
          , x = d3.scale.linear()
          , y = d3.scale.linear()
          , brush = d3.svg.brush()
              .x(x)
              .on("brush", brushed)
          , colorScale
          , noteHeight
          , roundedCornerSize
        ;

        function my(selection){
            selection.each(function (data){
                var svg = d3.select(this)
                      .attr("height", height)
                      .attr("width", width)
                  , notesG = svg.append("g")
                  , brushG = svg.append("g")
                      .attr("class", "x brush")
                ;
                x.domain([
                      d3.min(data, function(d) { return d.time; })
                    , d3.max(data, function(d) { return d.time + d.duration; })
                  ])
                ;
                y.domain([
                      d3.min(data, function(d) { return d.pitch - 1; })
                    , d3.max(data, function(d) { return d.pitch; })
                  ])
                ;
                x.range([0, width - 1]);
                y.range([height, 0]);

                noteHeight = height / (y.domain()[1] - y.domain()[0])
                roundedCornerSize = noteHeight / 2

                var rects = notesG.selectAll("rect").data(data);
                rects.enter().append("rect");
                rects.exit().remove();
                rects
                    .attr("x", function(d) { return x(d.time); })
                    .attr("y", function(d) { return y(d.pitch); })
                    .attr("width", function(d) { return x(d.time + d.duration) - x(d.time); })
                    .attr("height", noteHeight)
                    .attr("fill", function(d) { return colorScale(d.voice); })
                    .attr("stroke", function(d) { return colorScale(d.voice); })
                    .attr("rx", roundedCornerSize)
                    .attr("ry", roundedCornerSize)
                    .classed("note", true)
                ;

                brushG
                    .call(brush)
                  .selectAll("rect")
                    .attr("y", 0)
                    .attr("height", height - 1);
            });
        } // my()

        function brushed(){
            console.log("brushed");
        }

        my.colorScale = function (value){
            if(arguments.length === 0) return colorScale;
            colorScale = value;
            return my;
        };

        my.width = function (value){
            if(arguments.length === 0) return width;
            width = value;
            return my;
        };

        my.height = function (value){
            if(arguments.length === 0) return height;
            height = value;
            return my;
        };

        my.noteHeight = function (){ return noteHeight; };
        my.roundedCornerSize = function (){ return roundedCornerSize; };

        return my;
    }

    function ColorLegend(){
        var legend = d3.select("body #legend")
              .append("ul")
                .attr("class", "list-unstyled")
          , hilite
          , colorScale
          , noteHeight
          , roundedCornerSize
        ;

        function my(options) {
            var svg = d3.select("#notes-svg")
              , row = legend.selectAll("li")
                    .data(colorScale.domain())
            ;
            legend
                .on("click", function() {
                    hilite = false;
                    svg.selectAll("rect")
                        .classed("subdued", false)
                    ;
                  })
            ;
            row.enter()
              .append("li")
                .each(function(c) {
                    var self = d3.select(this);
                    self
                      .append("svg")
                        .attr("x", 0)
                        .attr("y", noteHeight)
                        .attr("width", 22)
                        .attr("height", noteHeight)
                      .append("rect")
                        .attr("class", c.toLowerCase())
                        .classed("note", true)
                        .attr("x", 0)
                        .attr("y", 0)
                        .attr("width", "100%")
                        .attr("height", "100%")
                        .attr("fill", colorScale(c))
                        .attr("stroke", colorScale(c))
                        .attr("rx", roundedCornerSize)
                        .attr("ry", roundedCornerSize)
                    ;
                    self
                      .append("text")
                        .text(c)
                    ;
                  })
            ;
            row
              .on("click", function(c) {
                  d3.event.stopPropagation();
                  hilite = hilite === c ? false : c;
                  svg.selectAll("rect.note")
                      .classed("subdued", function(d) {
                          return hilite && d.voice !== c;
                        })
                  ;
                  legend.selectAll("li")
                      .classed("subdued", function(d) {
                          return hilite && d !== c;
                        })
                  ;
                })
            ;
        } // my()

        my.colorScale = function (value){
            if(arguments.length === 0){
                return colorScale;
            }
            colorScale = value;
        };

        my.height = function (value){
            if(arguments.length === 0) return height;
            height = value;
            return my;
        };

        my.noteHeight = function (value){
            if(arguments.length === 0) return noteHeight;
            noteHeight = value;
            return my;
        };

        my.roundedCornerSize = function (value){
            if(arguments.length === 0) return roundedCornerSize;
            roundedCornerSize = value;
            return my;
        };

        return my;
    }
  </script>
</body>
