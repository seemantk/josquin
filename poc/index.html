<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="d3.min.js"></script>
</head>

<body>
  <script>

    var width = 900;
    var height = 150;
    var jsonPath = "Jos2721-La_Bernardina.json";

    var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);

    d3.json(jsonPath, function (prollData){
      var allNotes = [];
      prollData.partdata.forEach(function (part){
        var voice = prollData.partnames[part.partindex];
        part.notedata.forEach(function (note){
          allNotes.push({
            pitch: note.pitch.b7,
            time: note.starttime[0],
            duration: note.duration[0],
            voice: voice
          });
        });
      });
      render(allNotes);
    });

    var x = d3.scale.linear();
    var y = d3.scale.linear();
    var color = d3.scale.category10();

    function render(data){

      x.domain([
        d3.min(data, function (d){ return d.time; }),
        d3.max(data, function (d){ return d.time + d.duration; })
      ]);

      y.domain([
        d3.min(data, function (d){ return d.pitch - 1; }),
        d3.max(data, function (d){ return d.pitch; })
      ]);

      x.range([0, width]);
      y.range([height, 0]);

      var noteHeight = height / (y.domain()[1] - y.domain()[0]);
      var roundedCornerSize = noteHeight / 2;

      var rects = svg.selectAll("rect").data(data);
      rects.enter().append("rect");
      rects.exit().remove();
      rects
        .attr("x", function (d){ return x(d.time); })
        .attr("y", function (d){ return y(d.pitch); })
        .attr("width", function (d){ return x(d.time + d.duration) - x(d.time); })
        .attr("height", noteHeight)
        .attr("fill", function(d){ return color(d.voice); })
        .attr("stroke", function(d){ return color(d.voice); })
        .attr("fill-opacity", 0.5)
        .attr("rx", roundedCornerSize)
        .attr("ry", roundedCornerSize);
    }

  </script>
</body>
