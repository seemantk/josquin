<!DOCTYPE html>
<head>
  <meta charset="utf-8">

  <!--
    This program loads note data for a single work in CSV format
    and renders it using D3.js.

    By Curran Kelleher (curran.kelleher@gmail.com)
    April 2016
  -->
  <script src="d3.min.js"></script>
</head>

<body>
  <script>

    var width = 900;
    var height = 150;
    var fillOpacity = 0.5;
    var csvPath = "Jos2721-La_Bernardina.csv";

    var svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height);

    var x = d3.scale.linear();
    var y = d3.scale.linear();
    var color = d3.scale.category10();

    function render(data){

      x.domain([
        d3.min(data, function (d){ return d.time; }),
        d3.max(data, function (d){ return d.time + d.duration; })
      ]);

      y.domain([
        d3.min(data, function (d){ return d.pitch - 1; }),
        d3.max(data, function (d){ return d.pitch; })
      ]);

      x.range([0, width]);
      y.range([height, 0]);

      var noteHeight = height / (y.domain()[1] - y.domain()[0]);
      var roundedCornerSize = noteHeight / 2;

      var rects = svg.selectAll("rect").data(data);
      rects.enter().append("rect");
      rects.exit().remove();
      rects
        .attr("x", function (d){ return x(d.time); })
        .attr("y", function (d){ return y(d.pitch); })
        .attr("width", function (d){ return x(d.time + d.duration) - x(d.time); })
        .attr("height", noteHeight)
        .attr("fill", function(d){ return color(d.voice); })
        .attr("stroke", function(d){ return color(d.voice); })
        .attr("fill-opacity", fillOpacity)
        .attr("rx", roundedCornerSize)
        .attr("ry", roundedCornerSize);
    }

    // Parse strings from CSV data into numbers.
    function type (d){
      d.pitch = +d.pitch;
      d.time = +d.time;
      d.duration = +d.duration;
      return d;
    }

    d3.csv(csvPath, type, render);

  </script>
</body>
